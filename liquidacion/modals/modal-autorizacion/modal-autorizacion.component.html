<!-- ========================================================================== -->
<!-- MODAL - SOLICITUD DE AUTORIZACIÓN                                        -->
<!-- ========================================================================== -->

<!-- Overlay -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" (click)="cerrarModal()">

    <!-- Modal -->
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
        (click)="$event.stopPropagation()">

        <!-- Header -->
        <div class="flex items-center justify-between p-5 border-b border-gray-200 sticky top-0 bg-white z-10">
            <h2 class="text-lg font-bold text-gray-900">Solicitar Autorización</h2>
            <button (click)="cerrarModal()" [disabled]="guardando()"
                class="text-gray-400 hover:text-gray-600 transition disabled:opacity-50">
                <lucide-icon [img]="X" class="w-5 h-5"></lucide-icon>
            </button>
        </div>

        <!-- Body -->
        <form [formGroup]="form" (ngSubmit)="guardar()" class="p-5 space-y-4">

            <!-- Error global -->
            <div *ngIf="error()" class="flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-sm">
                <lucide-icon [img]="AlertCircle" class="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0"></lucide-icon>
                <span class="text-red-800">{{ error() }}</span>
            </div>

            <!-- Información de la factura -->
            <div class="bg-blue-50 rounded-lg border border-blue-200 p-3">
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <p class="text-xs text-blue-600 mb-0.5">Número de Factura</p>
                        <p class="font-semibold text-blue-900">{{ numeroFactura }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-blue-600 mb-0.5">Días Excedidos</p>
                        <p class="font-semibold text-blue-900">{{ diasHabilesExcedidos }} días</p>
                    </div>
                </div>
            </div>

            <!-- Alerta informativa -->
            <div class="flex items-start gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm">
                <lucide-icon [img]="AlertCircle" class="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"></lucide-icon>
                <div class="text-yellow-800">
                    <p class="font-medium text-xs mb-0.5">Autorización Requerida</p>
                    <p class="text-xs">
                        Esta factura ha excedido el plazo permitido. Justifique la tardanza para revisión.
                    </p>
                </div>
            </div>

            <!-- Justificación -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Justificación de la Tardanza <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="justificacion" rows="5" maxlength="1000"
                    placeholder="Explique el motivo de la presentación fuera de plazo..."
                    class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition resize-none"
                    [class.border-red-500]="esInvalido('justificacion')"
                    [class.border-gray-300]="!esInvalido('justificacion')"></textarea>
                <div class="flex items-center justify-between mt-1">
                    <p *ngIf="esInvalido('justificacion')" class="text-xs text-red-600">
                        {{ obtenerError('justificacion') }}
                    </p>
                    <p class="text-xs text-gray-500 ml-auto">
                        {{ form.get('justificacion')?.value?.length || 0 }}/1000 caracteres
                    </p>
                </div>
                <p class="mt-1 text-xs text-gray-500">
                    Mínimo 20 caracteres. Sea específico en su justificación.
                </p>
            </div>

            <!-- Archivo adjunto (opcional) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Archivo de Respaldo
                    <span class="text-gray-500 font-normal">(opcional)</span>
                </label>

                <!-- Input file oculto -->
                <input type="file" id="archivo-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    (change)="onArchivoSeleccionado($event)">

                <!-- Botón para seleccionar archivo -->
                <button *ngIf="!archivoSeleccionado()" type="button"
                    onclick="document.getElementById('archivo-input').click()"
                    class="w-full px-3 py-2.5 border-2 border-dashed border-gray-300 rounded-md hover:border-blue-400 hover:bg-blue-50 transition flex items-center justify-center gap-2 text-sm text-gray-600">
                    <lucide-icon [img]="Upload" class="w-4 h-4"></lucide-icon>
                    Seleccionar archivo
                </button>

                <!-- Preview del archivo seleccionado -->
                <div *ngIf="archivoSeleccionado()"
                    class="flex items-center gap-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                    <div class="w-8 h-8 bg-blue-50 rounded flex items-center justify-center flex-shrink-0">
                        <lucide-icon [img]="iconoArchivo" class="w-4 h-4 text-blue-600"></lucide-icon>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">{{ nombreArchivoSeleccionado }}</p>
                        <p class="text-xs text-gray-500">{{ tamanoArchivoSeleccionado }}</p>
                    </div>
                    <button type="button" (click)="removerArchivo()"
                        class="p-1.5 text-red-600 hover:bg-red-50 rounded transition flex-shrink-0">
                        <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
                    </button>
                </div>

                <p class="mt-1 text-xs text-gray-500">
                    PDF, imagen o Word (máximo 5MB)
                </p>
            </div>

        </form>

        <!-- Footer -->
        <div class="flex items-center justify-end gap-2 p-5 border-t border-gray-200 bg-gray-50 sticky bottom-0">
            <button type="button" (click)="cerrarModal()" [disabled]="guardando()"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition disabled:opacity-50">
                Cancelar
            </button>
            <button type="submit" (click)="guardar()" [disabled]="form.invalid || guardando()"
                class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                <lucide-icon [img]="Send" class="w-4 h-4"></lucide-icon>
                {{ textoBoton }}
            </button>
        </div>

    </div>
</div>