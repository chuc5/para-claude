<!-- ============================================================================ -->
<!-- TEMPLATE TABLA DETALLE LIQUIDACIONES - CORREGIDO CON PERMISOS DEL PADRE -->
<!-- ============================================================================ -->

<div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">

    <!-- Header de la tabla -->
    <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div class="text-sm font-medium text-gray-900 dark:text-gray-100">Detalle de Liquidación</div>
        <div class="space-x-2 flex">
            <!-- Solo botón Agregar -->
            <button
                class="px-3 py-1.5 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1"
                (click)="onAgregar()" [disabled]="!puedeAgregarDetalles()"
                [title]="puedeAgregarDetalles() ? 'Agregar nuevo detalle' : obtenerMensajePermisos()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14" />
                    <path d="M12 5v14" />
                </svg>
                Agregar
            </button>

            <!-- Indicador de permisos cuando no puede agregar -->
            <div *ngIf="!puedeAgregarDetalles()"
                class="px-2 py-1.5 text-xs text-orange-600 bg-orange-50 rounded border border-orange-200 flex items-center gap-1">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                Solo lectura
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="relative overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                <tr class="text-left">
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Orden</th>
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Usuario/Gasto</th>
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Descripción</th>
                    <th class="px-3 py-2 text-right text-gray-700 dark:text-gray-200">Monto</th>
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Forma pago</th>
                    <th class="px-3 py-2 text-center text-gray-700 dark:text-gray-200">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                <tr *ngFor="let detalle of detallesLiquidacion(); let i = index; trackBy: trackById"
                    class="hover:bg-gray-50 dark:hover:bg-gray-700/40">

                    <!-- Número de orden -->
                    <td class="px-3 py-2 font-medium text-gray-900 dark:text-gray-100">{{ detalle?.numero_orden }}</td>

                    <!-- Agencia con edición inline -->
                    <td class="px-3 py-2">
                        <ng-container *ngIf="detalle._editandoAgencia; else mostrarAgencia">
                            <select #agenciaInput [(ngModel)]="detalle._agenciaTemp" (blur)="guardarAgencia(i)"
                                (keydown.enter)="guardarAgencia(i)" (keydown.escape)="cancelarEdicionAgencia(i)"
                                class="w-full border rounded px-2 py-1 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="" disabled>Seleccione una agencia</option>
                                <option *ngFor="let agencia of agenciasDisponibles(); trackBy: trackByAgencia"
                                    [value]="agencia.nombre_liquidacion">
                                    {{ agencia.nombre_liquidacion }}
                                </option>
                            </select>
                        </ng-container>
                        <ng-template #mostrarAgencia>
                            <span class="text-gray-900 dark:text-gray-100"
                                [ngClass]="puedeEditarDetalles() ? 'cursor-pointer hover:text-blue-600 dark:hover:text-blue-400' : 'cursor-default'"
                                (click)="puedeEditarDetalles() ? iniciarEdicionAgencia(i) : null"
                                [title]="puedeEditarDetalles() ? 'Click para editar' : 'Edición no permitida'">
                                {{ detalle.agencia || 'Sin especificar' }}
                            </span>
                        </ng-template>
                    </td>

                    <!-- Descripción -->
                    <td class="px-3 py-2">
                        <div class="max-w-xs truncate text-gray-900 dark:text-gray-100" [title]="detalle?.descripcion">
                            {{ detalle?.descripcion }}
                        </div>
                    </td>

                    <!-- Monto con edición inline -->
                    <td class="px-3 py-2">
                        <ng-container *ngIf="detalle._editandoMonto; else mostrarMonto">
                            <input #montoInput type="number" [(ngModel)]="detalle._montoTemp" (blur)="guardarMonto(i)"
                                (keydown.enter)="guardarMonto(i)" (keydown.escape)="cancelarEdicionMonto(i)"
                                class="w-full border rounded px-2 py-1 text-right text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                min="0" step="0.01" />
                        </ng-container>
                        <ng-template #mostrarMonto>
                            <span class="text-right block text-gray-900 dark:text-gray-100"
                                [ngClass]="puedeEditarDetalles() ? 'cursor-pointer hover:text-blue-600 dark:hover:text-blue-400' : 'cursor-default'"
                                (click)="puedeEditarDetalles() ? iniciarEdicionMonto(i) : null"
                                [title]="puedeEditarDetalles() ? 'Click para editar' : 'Edición no permitida'">
                                Q{{ (detalle.monto || 0) | number:'1.2-2' }}
                            </span>
                        </ng-template>
                    </td>

                    <!-- Forma de pago -->
                    <td class="px-3 py-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                            [ngClass]="obtenerClaseFormaPago(detalle?.forma_pago || '')">
                            {{ obtenerTextoFormaPago(detalle?.forma_pago || '') }}
                        </span>
                    </td>

                    <!-- Acciones -->
                    <td class="px-3 py-2">
                        <div class="flex items-center justify-center gap-1">
                    
                            <!-- Ver detalle -->
                            <button class="p-1.5 rounded hover:bg-blue-50 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400"
                                (click)="verDetalleCompleto(i)" title="Ver detalle completo">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                    
                            <!-- Cambios solicitados -->
                            <!-- Botón Ver Cambios Solicitados -->
                            <button *ngIf="detalle.id"
                                class="relative p-1.5 rounded hover:bg-orange-50 dark:hover:bg-orange-900/30 text-orange-600 dark:text-orange-400"
                                (click)="abrirModalCambios(detalle)" [title]="
                                    detalle.tiene_cambios_pendientes === 1
                                        ? 'Tiene cambios pendientes por revisar'
                                        : detalle.tiene_cambios_pendientes === 2
                                        ? 'Cambios revisados'
                                        : 'Sin cambios pendientes'
                                ">
                            
                                <!-- Ícono base (siempre visible) -->
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                </svg>
                            
                                <!-- Indicador rojo: cambios pendientes -->
                                <span *ngIf="detalle.tiene_cambios_pendientes === 1"
                                    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-3 h-3 flex items-center justify-center border border-white dark:border-gray-800">
                                </span>
                            
                                <!-- Indicador verde: tuvo cambios pero ya revisados -->
                                <span *ngIf="detalle.tiene_cambios_pendientes === 2"
                                    class="absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-3 h-3 flex items-center justify-center border border-white dark:border-gray-800">
                                </span>
                            </button>
                            <!-- Editar -->
                            <button class="p-1.5 rounded text-amber-600 dark:text-amber-400 disabled:opacity-50 disabled:cursor-not-allowed"
                                [ngClass]="puedeEditarDetalles() ? 'hover:bg-amber-50 dark:hover:bg-amber-900/30' : 'opacity-50'"
                                [disabled]="!puedeEditarDetalles()" (click)="onEditar(i)"
                                [title]="puedeEditarDetalles() ? 'Editar completo' : 'Edición no permitida - ' + obtenerMensajePermisos()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
                                    <path d="m15 5 4 4" />
                                </svg>
                            </button>
                    
                            <!-- Copiar -->
                            <button class="p-1.5 rounded text-sky-600 dark:text-sky-400 disabled:opacity-50 disabled:cursor-not-allowed"
                                [ngClass]="puedeAgregarDetalles() ? 'hover:bg-sky-50 dark:hover:bg-sky-900/30' : 'opacity-50'"
                                [disabled]="!puedeAgregarDetalles()" (click)="onCopiar(i)"
                                [title]="puedeAgregarDetalles() ? 'Copiar' : 'Copia no permitida - ' + obtenerMensajePermisos()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                </svg>
                            </button>
                    
                            <!-- Eliminar -->
                            <button class="p-1.5 rounded text-red-600 dark:text-red-400 disabled:opacity-50 disabled:cursor-not-allowed"
                                [ngClass]="puedeEliminarDetalles() ? 'hover:bg-red-50 dark:hover:bg-red-900/30' : 'opacity-50'"
                                [disabled]="!puedeEliminarDetalles()" (click)="onEliminar(i)"
                                [title]="puedeEliminarDetalles() ? 'Eliminar' : 'Eliminación no permitida - ' + obtenerMensajePermisos()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18" />
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                    <line x1="10" x2="10" y1="11" y2="17" />
                                    <line x1="14" x2="14" y1="11" y2="17" />
                                </svg>
                            </button>
                        </div>
                    </td>
                <!-- Fila vacía -->
                <tr *ngIf="detallesLiquidacion().length === 0">
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center gap-2">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M12 16v-4" />
                                <path d="M12 8h.01" />
                            </svg>
                            <p class="text-sm">Sin registros de liquidación.</p>
                            <p class="text-xs text-gray-400" *ngIf="puedeAgregarDetalles()">
                                Usa "Agregar" para crear uno nuevo.
                            </p>
                            <p class="text-xs text-red-400" *ngIf="!puedeAgregarDetalles()">
                                {{ obtenerMensajePermisos() }}
                            </p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Indicador de guardando cambios -->
    <div *ngIf="guardandoCambios()" class="absolute inset-0 bg-black/10 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow-lg flex items-center gap-2">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
                <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            </svg>
            <span class="text-sm text-gray-700 dark:text-gray-200">Guardando cambios...</span>
        </div>
    </div>

    <!-- Mensaje de permisos en la parte inferior si no puede hacer nada -->
    <div *ngIf="!puedeEditarDetalles() && !puedeAgregarDetalles() && !puedeEliminarDetalles() && detallesLiquidacion().length > 0"
        class="px-3 py-2 bg-yellow-50 border-t border-yellow-200 text-yellow-800 text-xs flex items-center gap-2">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path
                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
        <span>{{ obtenerMensajePermisos() }}</span>
    </div>

</div>

<!-- Modales -->
<app-modal-detalle-liquidacion-presupuesto *ngIf="mostrarModalDetalle()" [visible]="mostrarModalDetalle()" [modo]="modoModal()"
    [registro]="registroEnEdicion" (visibleChange)="mostrarModalDetalle.set($event)">
</app-modal-detalle-liquidacion-presupuesto>

<app-modal-confirmar-eliminacion-presupuesto *ngIf="mostrarModalEliminar()" [titulo]="'Confirmar eliminación'"
    [mensaje]="'¿Está seguro(a) de eliminar este detalle? Esta acción no se puede deshacer.'"
    (confirmar)="confirmarEliminacion()" (cancelar)="cancelarEliminacion()">
</app-modal-confirmar-eliminacion-presupuesto>

<!-- Modal: Ver Cambios Solicitados -->
<app-modal-ver-cambios-usuario *ngIf="mostrarModalCambios()" [detalle]="detalleSeleccionadoParaCambios()"
    (cerrar)="cerrarModalCambios()" (cambiosActualizados)="cerrarModalCambios()">
</app-modal-ver-cambios-usuario>