<div class="w-full h-80 flex flex-col">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 h-full flex flex-col">

        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-sm font-medium text-gray-900">
                Gesti√≥n de <span
                    class="text-transparent bg-clip-text bg-gradient-to-r to-blue-600 from-indigo-400">Facturas</span>
            </h2>
            <button (click)="abrirModalRegistrar()"
                class="text-gray-400 hover:text-gray-500 p-1 rounded-full transition-colors"
                title="Registrar nueva factura">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>

        <!-- B√∫squeda y Acciones -->
        <div class="px-2 py-1 border-b border-gray-100">
            <div class="flex gap-2">
                <input [formControl]="searchControl" type="search"
                    class="pl-3 pr-3 py-2 block w-full text-sm text-gray-900 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                    placeholder="Ingrese n√∫mero DTE y presione Enter o espere (m√≠n. 3 caracteres)" />

                <button (click)="buscarManual()"
                    class="px-3 py-2 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Buscar
                </button>

                <!-- Bot√≥n de autorizaci√≥n solo si la factura lo requiere -->
                <ng-container *ngIf="facturaActual() as factura">
                    <button *ngIf="mostrarBotonAutorizacion(factura)"
                        class="px-3 py-2 text-xs bg-orange-600 text-white rounded-md hover:bg-orange-700"
                        (click)="abrirModalAutorizacion()">
                        Solicitar autorizaci√≥n
                    </button>
                </ng-container>
            </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="cargandoFactura()" class="flex-1 grid place-items-center p-6">
            <div class="flex items-center space-x-2 text-gray-500">
                <div class="w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>
                <span class="text-sm">Cargando...</span>
            </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!cargandoFactura() && !facturaActual()"
            class="flex-1 grid place-items-center p-6 text-sm text-gray-500">
            <span>Busque una factura para ver su detalle</span>
        </div>

        <!-- Contenido de la Factura - ACTUALIZADO CON D√çAS H√ÅBILES -->
        <ng-container *ngIf="!cargandoFactura() && facturaActual() as factura">
            <div class="px-2 py-1 overflow-auto">

                <!-- Badges de Estado Actualizados -->
                <div class="flex flex-wrap gap-1 mb-1">
                    <!-- Estado de Liquidaci√≥n -->
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="obtenerColorEstadoLiquidacion(factura.estado_liquidacion)">
                        Estado Liquidaci√≥n: {{ factura.estado_liquidacion }}
                    </span>

                    <!-- Estado de Factura -->
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="obtenerColorEstadoFactura(factura.estado_factura || 'vigente')">
                        Estado Factura: {{ factura.estado_factura || 'vigente' }}
                    </span>

                    <!-- NUEVO: Estado de Tiempo usando d√≠as h√°biles del backend -->
                    <span *ngIf="factura.dias_habiles" class="px-2.5 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="obtenerColorEstadoTiempo(factura.dias_habiles.estado_tiempo)">
                        {{ factura.dias_habiles.estado_tiempo }}
                        ({{ factura.dias_habiles.dias_transcurridos }}/{{ factura.dias_habiles.total_permitido }} d√≠as)
                    </span>

                    <!-- Estado de Autorizaci√≥n -->
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold capitalize"
                        [ngClass]="obtenerColorEstadoAutorizacion(factura.estado_autorizacion || 'ninguna')">
                        {{ factura.estado_autorizacion || 'no requerida' }}
                    </span>
                </div>

                <!-- Informaci√≥n Principal -->
                <div class="grid grid-cols-4 gap-x-4 gap-y-2 text-sm mb-2">
                    <div class="text-gray-500">N√∫mero DTE:</div>
                    <div class="font-medium text-gray-800 col-span-3">
                        <span class="bg-blue-50 px-2 py-0.5 rounded text-blue-800">
                            {{ factura.numero_dte }}
                        </span>
                    </div>

                    <div class="text-gray-500">Fecha Emisi√≥n:</div>
                    <div class="font-medium text-gray-800 col-span-1">{{ formatearFecha(factura.fecha_emision) }}</div>

                    <div class="text-gray-500">Tipo DTE:</div>
                    <div class="font-medium text-gray-800 col-span-1">{{ factura.tipo_dte }}</div>

                    <div class="text-gray-500">Autorizaci√≥n:</div>
                    <div class="font-medium text-gray-800 col-span-3">{{ factura.numero_autorizacion }}</div>

                    <div class="text-gray-500">Emisor:</div>
                    <div class="font-medium text-gray-800 col-span-3">{{ factura.nombre_emisor }}</div>

                    <div class="text-gray-500">Monto Factura:</div>
                    <div class="font-semibold text-gray-900 col-span-1">
                        {{ formatearMonto(factura.monto_total) }}
                    </div>

                    <div class="text-gray-500">Monto Liquidado:</div>
                    <div class="font-semibold text-gray-900 col-span-1">
                        {{ formatearMonto(calcularTotalDetalles()) }}
                    </div>

                    <div class="text-gray-500">Monto Retenci√≥n:</div>
                    <div class="font-semibold col-span-1"
                        [ngClass]="obtenerMontoRetencion() > 0 ? 'text-orange-700' : 'text-gray-500'">
                        {{ formatearMonto(obtenerMontoRetencion()) }}
                    </div>

                    <!-- NUEVA Informaci√≥n de Liquidaciones Registradas -->
                    <ng-container *ngIf="factura.cantidad_liquidaciones && factura.cantidad_liquidaciones > 0">
                        <div class="text-gray-500">Liquidaciones:</div>
                        <div class="font-medium text-gray-800 col-span-1">
                            {{ factura.cantidad_liquidaciones }} registradas
                        </div>
                    </ng-container>
                </div>

                <!-- NUEVA Secci√≥n: Informaci√≥n Detallada de D√≠as H√°biles -->
                <div *ngIf="factura.dias_habiles as diasHabiles" class="mb-3 border rounded p-3"
                    [ngClass]="obtenerColorEstadoTiempo(diasHabiles.estado_tiempo)">

                    <div class="text-sm font-semibold mb-2 flex items-center justify-between">
                        <span>Estado de Liquidaci√≥n por Tiempo</span>
                        <span class="text-xs font-normal">
                            {{ diasHabiles.dias_transcurridos }}/{{ diasHabiles.total_permitido }} d√≠as h√°biles
                        </span>
                    </div>

                    <!-- Barra de progreso de d√≠as h√°biles -->
                    <div class="mb-2">
                        <div class="w-full bg-white/50 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all duration-300"
                                [style.width.%]="obtenerProgresoDias()"
                                [ngClass]="diasHabiles.excede_limite ? 'bg-red-600' : (obtenerProgresoDias() > 80 ? 'bg-yellow-600' : 'bg-green-600')">
                            </div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-600 space-y-1 mb-2">
                        <div class="p-2 rounded bg-white/50">
                            {{ obtenerMensajeEstado() }}
                        </div>

                        <!-- Estad√≠sticas de la factura -->
                        <ng-container *ngIf="obtenerEstadisticasFactura() as stats">
                            <div><b>Total detalles:</b> {{ formatearMonto(stats.totalLiquidado || 0) }}</div>
                            <div><b>Pendiente:</b> {{ formatearMonto(stats.montoPendiente || 0) }}</div>
                            <div><b>Progreso:</b> {{ (stats.porcentajeLiquidado || 0) | number:'1.1-1' }}%</div>

                            <!-- NUEVA informaci√≥n de d√≠as h√°biles -->
                            <div><b>Estado tiempo:</b> {{ stats.estadoTiempo }}</div>
                            <div><b>D√≠as transcurridos:</b> {{ stats.diasTranscurridos }}</div>
                            <div *ngIf="stats.excedeLimite" class="text-red-600">
                                <b>‚ö†Ô∏è Fuera del tiempo permitido</b>
                            </div>
                            <div *ngIf="stats.requiereAutorizacion" class="text-orange-600">
                                <b>üîê Requiere autorizaci√≥n especial</b>
                            </div>
                        </ng-container>

                        <div *ngIf="hayDiferenciaMontos()" class="text-red-600">
                            <b>‚ö†Ô∏è Hay diferencias en los montos</b>
                        </div>
                    </div>

                    <!-- Informaci√≥n de autorizaci√≥n extendida -->
                    <div *ngIf="tieneAutorizacion()" class="text-xs text-gray-600 space-y-1 border-t pt-2">
                        <div class="font-semibold">Informaci√≥n de Autorizaci√≥n:</div>
                        <div><b>Estado:</b> {{ factura.estado_autorizacion }}</div>
                        <div *ngIf="factura.motivo_autorizacion"><b>Motivo:</b> {{ factura.motivo_autorizacion }}</div>
                        <div *ngIf="factura.fecha_solicitud"><b>Fecha solicitud:</b> {{
                            factura.fecha_solicitud }}</div>
                        <div *ngIf="factura.fecha_autorizacion"><b>Fecha autorizaci√≥n:</b> {{
                            factura.fecha_autorizacion }}</div>
                        <div *ngIf="factura.comentarios_autorizacion"><b>Comentarios:</b> {{
                            factura.comentarios_autorizacion }}</div>
                        <div *ngIf="factura.autorizado_por"><b>Autorizado por:</b> {{ factura.autorizado_por }}</div>
                    </div>

                    <!-- NUEVA Informaci√≥n detallada de d√≠as h√°biles -->
                    <div *ngIf="obtenerInfoDiasHabiles() as diasInfo"
                        class="text-xs text-gray-600 space-y-1 border-t pt-2">
                        <div class="font-semibold">Detalles de Tiempo:</div>
                        <div><b>Fecha emisi√≥n:</b> {{ formatearFecha(diasInfo.fechaEmision) }}</div>
                        <div><b>Inicio c√°lculo:</b> {{ formatearFecha(diasInfo.fechaInicioCalculo) }}</div>
                        <div><b>D√≠as permitidos:</b> {{ diasInfo.diasPermitidos }}</div>
                        <div><b>D√≠as gracia:</b> {{ diasInfo.diasGracia }}</div>
                        <div><b>Total permitido:</b> {{ diasInfo.totalPermitido }}</div>
                        <div><b>D√≠as transcurridos:</b> {{ diasInfo.diasTranscurridos }}</div>
                        <div [ngClass]="diasInfo.excedeLimite ? 'text-red-600 font-semibold' : 'text-green-600'">
                            <b>{{ diasInfo.excedeLimite ? '‚ùå Excede l√≠mite' : '‚úÖ Dentro del l√≠mite' }}</b>
                        </div>
                    </div>
                </div>

                <!-- Barra de progreso de liquidaci√≥n -->
                <ng-container *ngIf="obtenerEstadisticasFactura() as stats">
                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progreso de liquidaci√≥n</span>
                            <span>{{ (stats.porcentajeLiquidado || 0) | number:'1.1-1' }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all duration-300"
                                [style.width.%]="stats.porcentajeLiquidado || 0"
                                [ngClass]="(stats.porcentajeLiquidado || 0) >= 100 ? 'bg-green-600' : (stats.porcentajeLiquidado || 0) > 100 ? 'bg-red-600' : 'bg-blue-600'">
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>
        </ng-container>

    </div>

    <!-- Modales -->
    <app-modal-registrar-factura-presupuesto *ngIf="mostrarModalRegistrar()" (cerrar)="cerrarModalRegistrar()"
        (facturaRegistrada)="onFacturaRegistrada()">
    </app-modal-registrar-factura-presupuesto>

    <app-modal-solicitar-autorizacion-presupuesto *ngIf="mostrarModalAutorizacion() && facturaActual() as factura"
        [numeroDte]="factura.numero_dte" [fechaEmision]="factura.fecha_emision"
        [diasTranscurridos]="obtenerDiasTranscurridos()" (cerrar)="cerrarModalAutorizacion()"
        (solicitudEnviada)="onSolicitudEnviada()">
    </app-modal-solicitar-autorizacion-presupuesto>

</div>